<div class="user-page">
  <!-- Breadcrumb -->
  <div class="breadcrumb-section">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="javascript:void(0)">Admin</a></li>
        <li class="breadcrumb-item"><a href="/setup">Setup</a></li>
        <li class="breadcrumb-item"><a href="/setup/users">User Management</a></li>
        <li class="breadcrumb-item active">
          {{ mode === 'create' ? 'Add User' : mode === 'edit' ? 'Edit User' : 'User Details' }}
        </li>
      </ol>
    </nav>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="fas fa-user-circle me-2"></i>
        {{ mode === 'create' ? 'Add User' : mode === 'edit' ? 'Edit User' : 'User Details' }}
      </h1>
      <p class="text-muted">
        {{ mode === 'create' ? 'Create a new system user account' : 
           mode === 'edit' ? 'Update user information and permissions' : 
           'View user information and permissions' }}
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline-secondary me-2" (click)="onCancel()">
        <i class="fas fa-arrow-left me-2"></i>
        Back to List
      </button>
      <button *ngIf="mode === 'edit'" class="btn btn-outline-primary" (click)="onViewMode()">
        <i class="fas fa-eye me-2"></i>
        View Mode
      </button>
      <button *ngIf="mode === 'view'" class="btn btn-outline-primary" (click)="onEditMode()">
        <i class="fas fa-edit me-2"></i>
        Edit Mode
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="state-container">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Loading user data...</p>
  </div>

  <!-- Form Content -->
  <div *ngIf="!isLoading" class="content-area">
    <div class="content-body">
      <!-- Alert Messages -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <div *ngIf="mode !== 'create'" class="mt-2">
          <button 
            type="button" 
            class="btn btn-outline-light btn-sm me-2"
            (click)="refreshUserData()"
            [disabled]="isLoading"
          >
            <i class="fas fa-refresh me-1"></i>
            Try Again
          </button>
          <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
        </div>
        <button *ngIf="mode === 'create'" type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
      </div>

      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
        <!-- User Profile Card -->
        <div class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-user me-2"></i>
              User Profile
            </h5>
          </div>
          <div class="card-body">
            <!-- Profile Image Section -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="profile-section">
                  <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                      <div class="image-preview-container">
                        <div class="image-preview-wrapper">
                          <img 
                            *ngIf="fileUpload.preview || currentUser?.UserImage"
                            [src]="fileUpload.preview || (currentUser?.UserImage ?? '/assets/images/default-avatar.png')" 
                            alt="User Image"
                            class="img-fluid"
                          />
                          <div 
                            *ngIf="!fileUpload.preview && !currentUser?.UserImage"
                            class="placeholder-image"
                          >
                            <i class="fas fa-user"></i>
                          </div>
                        </div>
                      </div>
                      <p class="text-muted mt-2 small">{{ fileUpload.name || 'No image selected' }}</p>
                    </div>
                    <div class="col-md-9">
                      <div class="upload-actions">
                        <div *ngIf="mode !== 'view'" class="mb-3">
                          <label for="imageInput" class="form-label">Profile Picture</label>
                          <input 
                            type="file" 
                            id="imageInput"
                            class="form-control" 
                            accept="image/*"
                            (change)="onFileSelected($event)"
                            [disabled]="mode === 'view'"
                          />
                          <small class="text-muted">JPG, PNG or GIF (Max 5MB)</small>
                        </div>
                        <button 
                          *ngIf="fileUpload.preview || currentUser?.UserImage"
                          type="button" 
                          class="btn btn-outline-danger btn-sm"
                          (click)="onRemoveImage()"
                          [disabled]="mode === 'view'"
                        >
                          <i class="fas fa-trash me-2"></i>
                          Remove Image
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <!-- Basic Information -->
            <div class="form-section">
              <h6 class="section-title">Basic Information</h6>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label">
                    Email <span class="text-danger">*</span>
                  </label>
                  <input 
                    type="email" 
                    id="email"
                    class="form-control" 
                    formControlName="Email"
                    [readonly]="mode === 'view'"
                  />
                  <div *ngIf="userForm.get('Email')?.invalid && userForm.get('Email')?.touched" class="invalid-feedback d-block">
                    Please enter a valid email address
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="phone" class="form-label">Phone Number</label>
                  <input 
                    type="text" 
                    id="phone"
                    class="form-control" 
                    formControlName="PhoneNumber"
                    [readonly]="mode === 'view'"
                    placeholder="e.g., +1 (555) 000-0000"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="firstName" class="form-label">First Name</label>
                  <input 
                    type="text" 
                    id="firstName"
                    class="form-control" 
                    formControlName="FirstName"
                    [readonly]="mode === 'view'"
                  />
                </div>

                <div class="col-md-4 mb-3">
                  <label for="middleName" class="form-label">Middle Name</label>
                  <input 
                    type="text" 
                    id="middleName"
                    class="form-control" 
                    formControlName="MiddleName"
                    [readonly]="mode === 'view'"
                  />
                </div>

                <div class="col-md-4 mb-3">
                  <label for="lastName" class="form-label">Last Name</label>
                  <input 
                    type="text" 
                    id="lastName"
                    class="form-control" 
                    formControlName="LastName"
                    [readonly]="mode === 'view'"
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-12 mb-3">
                  <label for="address" class="form-label">Address</label>
                  <textarea 
                    id="address"
                    class="form-control" 
                    formControlName="Address"
                    [readonly]="mode === 'view'"
                    rows="3"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Security Card -->
        <div *ngIf="mode !== 'view'" class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-lock me-2"></i>
              Security Settings
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="password" class="form-label">
                  {{ mode === 'create' ? 'Password' : 'New Password' }}
                  <span *ngIf="mode === 'create'" class="text-danger">*</span>
                  <span *ngIf="mode === 'edit'" class="small text-muted">(leave blank to keep current)</span>
                </label>
                <input 
                  type="password" 
                  id="password"
                  class="form-control" 
                  formControlName="Password"
                  [readonly]="mode === 'view'"
                />
                <div *ngIf="userForm.get('Password')?.invalid && userForm.get('Password')?.touched" class="invalid-feedback d-block">
                  {{ mode === 'create' ? 'Password is required (min 6 characters)' : 'Minimum 6 characters' }}
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <label for="confirmPassword" class="form-label">
                  Confirm Password
                  <span *ngIf="mode === 'create'" class="text-danger">*</span>
                </label>
                <input 
                  type="password" 
                  id="confirmPassword"
                  class="form-control" 
                  formControlName="ConfirmPassword"
                  [readonly]="mode === 'view'"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Roles Card -->
        <div class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-shield-alt me-2"></i>
              Roles & Permissions <span class="text-danger">*</span>
            </h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Select one or more roles for this user</p>
            <div class="roles-grid">
              <div *ngFor="let role of roles" class="role-checkbox">
                <div class="form-check">
                  <input 
                    type="checkbox" 
                    [id]="'role-' + role"
                    class="form-check-input" 
                    [checked]="isRoleSelected(role)"
                    (change)="onRoleChange(role)"
                    [disabled]="mode === 'view'"
                  />
                  <label [for]="'role-' + role" class="form-check-label">
                    <i [ngClass]="getRoleIcon(role)" class="me-2"></i>
                    {{ role }}
                  </label>
                </div>
              </div>
            </div>
            <div *ngIf="mode === 'create' && selectedRoles.length === 0" class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-circle me-2"></i>
              Please select at least one role for this user
            </div>
          </div>
        </div>

        <!-- Status Card -->
        <div class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-toggle-on me-2"></i>
              Account Status
            </h5>
          </div>
          <div class="card-body">
            <div class="form-check form-switch">
              <input 
                type="checkbox" 
                id="isActive"
                class="form-check-input" 
                formControlName="IsActive"
                [disabled]="mode === 'view'"
              />
              <label class="form-check-label" for="isActive">
                Active Account
              </label>
            </div>
            <small class="text-muted d-block mt-2">
              {{ userForm.get('IsActive')?.value ? 'This user account is active' : 'This user account is inactive' }}
            </small>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-outline-secondary"
            (click)="onCancel()"
            [disabled]="isSubmitting"
          >
            <i class="fas fa-times me-2"></i>
            Cancel
          </button>
          <button 
            *ngIf="mode !== 'view'"
            type="submit" 
            class="btn btn-primary"
            [disabled]="isSubmitting || !userForm.valid"
          >
            <i class="fas fa-save me-2"></i>
            {{ isSubmitting ? 'Saving...' : (mode === 'create' ? 'Create User' : 'Update User') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
