<div class="user-page">
  <!-- Breadcrumb -->
  <div class="breadcrumb-section">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="javascript:void(0)">Admin</a></li>
        <li class="breadcrumb-item"><a href="/setup">Setup</a></li>
        <li class="breadcrumb-item"><a href="/setup/users">User Management</a></li>
        <li class="breadcrumb-item active">
          {{ mode === 'create' ? 'Add User' : mode === 'edit' ? 'Edit User' : 'User Details' }}
        </li>
      </ol>
    </nav>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="fas fa-user-circle me-2"></i>
        {{ mode === 'create' ? 'Add User' : mode === 'edit' ? 'Edit User' : 'User Details' }}
      </h1>
      <p class="text-muted">
        {{ mode === 'create' ? 'Create a new system user account' : 
           mode === 'edit' ? 'Update user information and permissions' : 
           'View user information and permissions' }}
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline-secondary me-2" (click)="onCancel()">
        <i class="fas fa-arrow-left me-2"></i>
        Back to List
      </button>
      <button *ngIf="mode === 'edit'" class="btn btn-outline-primary" (click)="onViewMode()">
        <i class="fas fa-eye me-2"></i>
        View Mode
      </button>
      <button *ngIf="mode === 'view'" class="btn btn-outline-primary" (click)="onEditMode()">
        <i class="fas fa-edit me-2"></i>
        Edit Mode
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="state-container">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Loading user data...</p>
  </div>

  <!-- Form Content -->
  <div *ngIf="!isLoading" class="content-area">
    <div class="content-body">
      <!-- Alert Messages -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <div *ngIf="mode !== 'create'" class="mt-2">
          <button 
            type="button" 
            class="btn btn-outline-light btn-sm me-2"
            (click)="refreshUserData()"
            [disabled]="isLoading"
          >
            <i class="fas fa-refresh me-1"></i>
            Try Again
          </button>
          <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
        </div>
        <button *ngIf="mode === 'create'" type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
      </div>

      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
        <!-- Profile Image Section -->
        <div class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-user me-2"></i>
              User Profile
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-12">
                <div class="profile-section">
                  <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                      <div class="image-preview-container">
                        <div class="image-preview-wrapper">
                          <img 
                            [src]="getUserImageUrl()" 
                            alt="User Image"
                            class="image-preview-image"
                            onerror="this.src='/assets/images/default-profile-icon.png'"
                          >
                          <div *ngIf="!fileUpload.preview && !currentUser?.UserImage" class="image-placeholder">
                            <i class="fas fa-user-circle image-placeholder-icon"></i>
                          </div>
                        </div>
                        <button 
                          *ngIf="mode !== 'view' && (fileUpload.preview || currentUser?.UserImage)"
                          type="button" 
                          class="btn-remove-image"
                          (click)="onRemoveImage()"
                          title="Remove Image"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-9">
                      <div class="image-upload-content">
                        <h6 class="image-title">Profile Picture</h6>
                        <p class="image-subtitle">Upload user profile image (JPG, PNG, or GIF - Max 5MB)</p>
                        
                        <div *ngIf="mode !== 'view'" class="image-upload-actions">
                          <div class="file-input-wrapper">
                            <input
                              type="file"
                              id="userImage"
                              accept="image/jpeg,image/jpg,image/png,image/gif"
                              (change)="onFileSelected($event)"
                              class="image-file-input"
                            >
                            <label for="userImage" class="btn btn-primary btn-image-upload">
                              <i class="fas fa-upload me-2"></i>
                              {{ fileUpload.name ? 'Change Image' : 'Choose Image' }}
                            </label>
                          </div>
                          
                          <div *ngIf="fileUpload.name" class="file-info">
                            <small class="text-muted">
                              <i class="fas fa-file me-1"></i>
                              {{ fileUpload.name }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Details Form - Three Input Boxes Per Line -->
            <div class="three-column-form">
              <!-- Row 1: Email, First Name, Middle Name -->
              <div class="form-triplet">
                <div class="form-field">
                  <label for="Email" class="form-label required">Email Address</label>
                  <input
                    type="email"
                    class="form-control"
                    id="Email"
                    formControlName="Email"
                    placeholder="Enter email address"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['Email']?.touched && f['Email']?.invalid" class="form-error">
                    <small *ngIf="f['Email']?.errors?.['required']">Email is required</small>
                    <small *ngIf="f['Email']?.errors?.['email']">Please enter a valid email address</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="FirstName" class="form-label">First Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="FirstName"
                    formControlName="FirstName"
                    placeholder="Enter first name"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['FirstName']?.touched && f['FirstName']?.invalid" class="form-error">
                    <small *ngIf="f['FirstName']?.errors?.['maxlength']">Cannot exceed 100 characters</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="MiddleName" class="form-label">Middle Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="MiddleName"
                    formControlName="MiddleName"
                    placeholder="Enter middle name (optional)"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['MiddleName']?.touched && f['MiddleName']?.invalid" class="form-error">
                    <small *ngIf="f['MiddleName']?.errors?.['maxlength']">Cannot exceed 100 characters</small>
                  </div>
                </div>
              </div>

              <!-- Row 2: Last Name, Phone Number, Address -->
              <div class="form-triplet">
                <div class="form-field">
                  <label for="LastName" class="form-label">Last Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="LastName"
                    formControlName="LastName"
                    placeholder="Enter last name"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['LastName']?.touched && f['LastName']?.invalid" class="form-error">
                    <small *ngIf="f['LastName']?.errors?.['maxlength']">Cannot exceed 100 characters</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="PhoneNumber" class="form-label">Phone Number</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="PhoneNumber"
                    formControlName="PhoneNumber"
                    placeholder="Enter phone number"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['PhoneNumber']?.touched && f['PhoneNumber']?.invalid" class="form-error">
                    <small *ngIf="f['PhoneNumber']?.errors?.['maxlength']">Cannot exceed 20 characters</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="Address" class="form-label">Address</label>
                  <input
                    type="text"
                    class="form-control"
                    id="Address"
                    formControlName="Address"
                    placeholder="Enter address"
                    [disabled]="mode === 'view'"
                  >
                  <div *ngIf="f['Address']?.touched && f['Address']?.invalid" class="form-error">
                    <small *ngIf="f['Address']?.errors?.['maxlength']">Cannot exceed 255 characters</small>
                  </div>
                </div>
              </div>

              <!-- Row 3: Password, Confirm Password, Status -->
              <div *ngIf="mode !== 'view'" class="form-triplet">
                <div class="form-field">
                  <label for="Password" class="form-label">
                    {{ mode === 'create' ? 'Password' : 'New Password' }}
                    <span *ngIf="mode === 'create'" class="text-danger">*</span>
                    <span *ngIf="mode === 'edit'" class="small text-muted">(leave blank to keep current)</span>
                  </label>
                  <input
                    type="password"
                    class="form-control"
                    id="Password"
                    formControlName="Password"
                    placeholder="{{ mode === 'create' ? 'Enter password' : 'Enter new password (optional)' }}"
                  >
                  <div *ngIf="f['Password']?.touched && f['Password']?.invalid" class="form-error">
                    <small *ngIf="f['Password']?.errors?.['minlength']">Password must be at least 6 characters</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="ConfirmPassword" class="form-label">
                    Confirm Password
                    <span *ngIf="mode === 'create'" class="text-danger">*</span>
                  </label>
                  <input
                    type="password"
                    class="form-control"
                    id="ConfirmPassword"
                    formControlName="ConfirmPassword"
                    placeholder="Confirm password"
                  >
                  <div *ngIf="f['ConfirmPassword']?.touched && f['ConfirmPassword']?.invalid" class="form-error">
                    <small *ngIf="f['ConfirmPassword']?.errors?.['passwordMismatch']">Passwords do not match</small>
                  </div>
                </div>
                <div class="form-field">
                  <label for="IsActive" class="form-label">Account Status</label>
                  <div class="form-check form-switch">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="IsActive"
                      formControlName="IsActive"
                    >
                    <label class="form-check-label" for="IsActive">
                      {{ userForm.get('IsActive')?.value ? 'Active' : 'Inactive' }}
                    </label>
                  </div>
                  <small class="text-muted">
                    {{ userForm.get('IsActive')?.value ? 'User account is active' : 'User account is inactive' }}
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Roles & Permissions Card -->
        <div class="card form-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-shield-alt me-2"></i>
              Roles & Permissions <span class="text-danger">*</span>
            </h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Select one or more roles for this user</p>
            <div class="roles-container">
              <div *ngFor="let role of roles" class="role-checkbox" [class.checked]="roleChecked[role]" [class.disabled]="mode === 'view'">
                <label class="role-label" [for]="'role-' + role">
                  <input 
                    type="checkbox" 
                    [id]="'role-' + role"
                    [checked]="roleChecked[role]"
                    (change)="onRoleChange(role)"
                    [disabled]="mode === 'view'"
                  />
                  <span class="role-checkbox-custom"></span>
                  <span class="role-name">{{ role }}</span>
                </label>
              </div>
            </div>
            <div *ngIf="mode === 'create' && selectedRoles.length === 0" class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-circle me-2"></i>
              Please select at least one role for this user
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div *ngIf="mode !== 'view'" class="form-actions">
          <button 
            type="button" 
            class="btn btn-secondary me-2"
            (click)="onCancel()"
            [disabled]="isSubmitting"
          >
            <i class="fas fa-arrow-left me-2"></i>
            Cancel
          </button>
          
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="isSubmitting || userForm.invalid || (mode === 'create' && selectedRoles.length === 0)"
          >
            <i class="fas fa-save me-2"></i>
            {{ isSubmitting ? 'Saving...' : (currentUser ? 'Update User' : 'Create User') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
